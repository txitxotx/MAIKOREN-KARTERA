
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gr√°fica por Activo - An√°lisis Individual</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
        .charts-section {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            justify-content: center;
            margin: 30px 0;
        }
        .chart-box {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            width: 48%;
            min-width: 400px;
        }
        .chart-title {
            color: #00FF00;
            text-align: center;
            margin-bottom: 20px;
        }
        #bar-chart-individual, #pie-chart-individual {
            width: 100%;
            height: 500px;
        }
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .filter-btn {
            background: rgba(255, 152, 0, 0.2);
            color: #ff9800;
            border: 1px solid #ff9800;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .filter-btn:hover, .filter-btn.active {
            background: #ff9800;
            color: #000;
        }
        .asset-details {
            margin-top: 40px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }
        .asset-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .asset-row:hover {
            background: rgba(255, 255, 255, 0.05);
        }
        @media (max-width: 900px) {
            .chart-box { width: 100%; min-width: auto; }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <div class="navbar" id="navbar">
        <div class="navbar-content">
            <a href="/">Cartera Completa</a>
            <a href="/tables">Cartera por Tipos</a>
            <a href="/pie-chart">Composici√≥n Cartera</a>
            <a href="/investment-categories">Gr√°fica por Activo</a>
            <a href="/bank">Bancos & Brokers</a>
            <a href="/graphs">Gr√°ficas</a>
        </div>
    </div>

    <div class="container">
        <h1>An√°lisis por Activo Individual</h1>
        <p style="text-align: center; color: #ccc; margin-bottom: 20px;">
            Visualizaci√≥n detallada del rendimiento de cada activo en tu cartera
        </p>
        
        <!-- Controles de filtro -->
        <div class="controls">
            <button class="filter-btn active" onclick="filterByType('all')">Todos</button>
            <button class="filter-btn" onclick="filterByType('dca')">DCA</button>
            <button class="filter-btn" onclick="filterByType('renta_fija')">Renta Fija</button>
            <button class="filter-btn" onclick="filterByType('renta_variable')">Renta Variable</button>
            <button class="filter-btn" onclick="filterByType('cryptomonedas')">Cryptomonedas</button>
        </div>
        
        <!-- Gr√°ficos -->
        <div class="charts-section">
            <div class="chart-box">
                <h2 class="chart-title">üìä Valor por Activo</h2>
                <div id="bar-chart-individual"></div>
            </div>
            
            <div class="chart-box">
                <h2 class="chart-title">ü•ß Distribuci√≥n por Activo</h2>
                <div id="pie-chart-individual"></div>
            </div>
        </div>
        
        <!-- Detalles de activos -->
        <div class="asset-details">
            <h2 style="color: #ff9800; margin-top: 0;">üìã Detalles de Activos</h2>
            <div id="assets-list">
                <div style="text-align: center; padding: 30px;">
                    <div style="width: 40px; height: 40px; border: 4px solid #333; 
                         border-top: 4px solid #00FF00; border-radius: 50%; 
                         animation: spin 1s linear infinite; margin: 0 auto;"></div>
                    <p style="margin-top: 15px;">Cargando detalles de activos...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allInvestments = [];
        let currentFilter = 'all';
        
        // Cuando se carga la p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìà P√°gina investment-categories.html cargada');
            loadInvestmentsData();
            
            // A√±adir estilo para spinner
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
        });
        
        // Cargar datos de inversiones
        async function loadInvestmentsData() {
            try {
                console.log('üì• Obteniendo datos de inversiones...');
                const response = await fetch('/api/portfolio');
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                console.log('‚úÖ Datos recibidos:', data);
                
                if (data.success && data.investments && data.investments.length > 0) {
                    allInvestments = data.investments;
                    displayData(allInvestments);
                } else {
                    showError('No hay datos de inversiones');
                    // Datos de ejemplo
                    allInvestments = getExampleInvestments();
                    displayData(allInvestments);
                }
            } catch (error) {
                console.error('‚ùå Error:', error);
                showError('Error al cargar: ' + error.message);
                allInvestments = getExampleInvestments();
                displayData(allInvestments);
            }
        }
        
        // Mostrar datos
        function displayData(investments) {
            updateFilterButtons();
            renderBarChart(investments);
            renderPieChart(investments);
            renderAssetsList(investments);
        }
        
        // Filtrar por tipo
        function filterByType(type) {
            currentFilter = type;
            
            let filtered = allInvestments;
            if (type !== 'all') {
                filtered = allInvestments.filter(inv => {
                    const invType = (inv.investment_type || '').toLowerCase();
                    if (type === 'dca') return invType.includes('dca');
                    if (type === 'renta_fija') return invType.includes('renta fija');
                    if (type === 'renta_variable') return invType.includes('renta variable');
                    if (type === 'cryptomonedas') return invType.includes('crypto');
                    return true;
                });
            }
            
            displayData(filtered);
        }
        
        // Actualizar botones de filtro
        function updateFilterButtons() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                const filterType = btn.onclick.toString().match(/'([^']+)'/)[1];
                btn.classList.toggle('active', filterType === currentFilter);
            });
        }
        
        // Renderizar gr√°fico de barras
        function renderBarChart(investments) {
            // Ordenar por valor descendente (m√°ximo 15 activos)
            const sorted = [...investments]
                .sort((a, b) => (b.total_money || 0) - (a.total_money || 0))
                .slice(0, 15);
            
            const names = sorted.map(inv => 
                inv.asset_name.length > 20 ? inv.asset_name.substring(0, 20) + '...' : inv.asset_name
            );
            const values = sorted.map(inv => parseFloat(inv.total_money || inv.amount || 0));
            const yields = sorted.map(inv => parseFloat(inv.profit_loss_percentage || 0));
            
            // Colores basados en rendimiento
            const colors = yields.map(y => 
                y > 0 ? '#00FF00' : y < 0 ? '#FF0000' : '#888'
            );
            
            const trace = {
                x: names,
                y: values,
                type: 'bar',
                orientation: 'v',
                marker: {
                    color: colors,
                    line: { color: 'rgba(255,255,255,0.5)', width: 1 }
                },
                text: values.map((v, i) => 
                    `‚Ç¨${v.toLocaleString('es-ES', {minimumFractionDigits: 2})}<br>${yields[i].toFixed(2)}%`
                ),
                textposition: 'auto',
                hoverinfo: 'text',
                hovertemplate: '<b>%{x}</b><br>Valor: ‚Ç¨%{y:,.2f}<br>Rendimiento: %{customdata}%<extra></extra>',
                customdata: yields
            };
            
            const layout = {
                title: {
                    text: `Top ${sorted.length} Activos por Valor`,
                    font: { size: 16, color: '#fff' }
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#fff', family: 'Roboto' },
                xaxis: {
                    tickangle: -45,
                    tickfont: { size: 11, color: '#ccc' }
                },
                yaxis: {
                    title: { text: 'Valor (‚Ç¨)', font: { color: '#ccc' } },
                    gridcolor: 'rgba(255,255,255,0.1)',
                    tickfont: { color: '#ccc' }
                },
                margin: { l: 80, r: 30, b: 100, t: 50 }
            };
            
            Plotly.newPlot('bar-chart-individual', [trace], layout, { responsive: true });
        }
        
        // Renderizar gr√°fico circular
        function renderPieChart(investments) {
            // Tomar los 10 principales por valor
            const topInvestments = [...investments]
                .sort((a, b) => (b.total_money || 0) - (a.total_money || 0))
                .slice(0, 10);
            
            const otherValue = investments
                .slice(10)
                .reduce((sum, inv) => sum + parseFloat(inv.total_money || inv.amount || 0), 0);
            
            const labels = topInvestments.map(inv => 
                inv.asset_name.length > 15 ? inv.asset_name.substring(0, 15) + '...' : inv.asset_name
            );
            const values = topInvestments.map(inv => parseFloat(inv.total_money || inv.amount || 0));
            
            // A√±adir "Otros" si hay m√°s de 10
            if (otherValue > 0) {
                labels.push('Otros');
                values.push(otherValue);
            }
            
            const trace = {
                labels: labels,
                values: values,
                type: 'pie',
                hole: 0.3,
                textinfo: 'label+percent',
                textposition: 'outside',
                hoverinfo: 'label+value+percent',
                hovertemplate: '<b>%{label}</b><br>Valor: ‚Ç¨%{value:,.2f}<br>Porcentaje: %{percent}<extra></extra>',
                marker: {
                    colors: ['#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7', 
                            '#DDA0DD', '#98D8C8', '#F7DC6F', '#A29BFE', '#55EFC4']
                }
            };
            
            const totalValue = values.reduce((a, b) => a + b, 0);
            
            const layout = {
                title: {
                    text: `Distribuci√≥n (Total: ‚Ç¨${totalValue.toLocaleString('es-ES', {minimumFractionDigits: 2})})`,
                    font: { size: 16, color: '#fff' }
                },
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { color: '#fff', family: 'Roboto' },
                showlegend: true,
                legend: {
                    x: 1.1,
                    y: 0.5,
                    font: { size: 11, color: '#ccc' },
                    bgcolor: 'rgba(30, 30, 30, 0.8)'
                },
                margin: { l: 20, r: 150, b: 20, t: 50 }
            };
            
            Plotly.newPlot('pie-chart-individual', [trace], layout, { responsive: true });
        }
        
        // Renderizar lista de activos
        function renderAssetsList(investments) {
            const container = document.getElementById('assets-list');
            let html = '';
            
            // Ordenar por valor descendente
            const sorted = [...investments].sort((a, b) => 
                (b.total_money || 0) - (a.total_money || 0)
            );
            
            sorted.forEach(inv => {
                const value = parseFloat(inv.total_money || inv.amount || 0);
                const yieldVal = parseFloat(inv.profit_loss_percentage || 0);
                const yieldClass = yieldVal > 0 ? 'positive' : (yieldVal < 0 ? 'negative' : '');
                const category = inv.investment_type || 'Sin categor√≠a';
                
                html += `
                    <div class="asset-row">
                        <div style="flex: 2;">
                            <strong>${inv.asset_name}</strong><br>
                            <small style="color: #aaa;">${inv.isin || ''} | ${category}</small>
                        </div>
                        <div style="flex: 1; text-align: right;">
                            <div>${formatCurrency(value)}</div>
                            <div class="${yieldClass}">${yieldVal.toFixed(2)}%</div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // Formatear moneda
        function formatCurrency(value) {
            return new Intl.NumberFormat('es-ES', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value) + '‚Ç¨';
        }
        
        // Datos de ejemplo
        function getExampleInvestments() {
            return [
                { asset_name: "Bitcoin", isin: "BTC-USD", total_money: 15000, profit_loss_percentage: 25.5, investment_type: "Cryptomonedas" },
                { asset_name: "Apple Inc.", isin: "AAPL", total_money: 12000, profit_loss_percentage: 8.7, investment_type: "Acciones" },
                { asset_name: "Fondo DCA RF", isin: "0P000125T6.F", total_money: 25000, profit_loss_percentage: 5.2, investment_type: "DCA RF Y RV" },
                { asset_name: "Fondo Renta Fija", isin: "0P0001B7DE.F", total_money: 18000, profit_loss_percentage: 3.1, investment_type: "Renta Fija" },
                { asset_name: "Fondo RV Global", isin: "0P00000DQZ.F", total_money: 9500, profit_loss_percentage: 12.3, investment_type: "Renta Variable" },
                { asset_name: "Solana", isin: "SOL-USD", total_money: 7500, profit_loss_percentage: 18.9, investment_type: "Cryptomonedas" },
                { asset_name: "Proyecto Crowdfunding", isin: "CROWDF-1", total_money: 5000, profit_loss_percentage: 10.0, investment_type: "Crowfounding" },
                { asset_name: "Microsoft", isin: "MSFT", total_money: 8500, profit_loss_percentage: 7.8, investment_type: "Acciones" },
                { asset_name: "Fondo Emergentes", isin: "0P00000DS1.F", total_money: 6500, profit_loss_percentage: -2.5, investment_type: "Renta Variable" },
                { asset_name: "Baskepensiones", isin: "0P0001L8YS.F", total_money: 12000, profit_loss_percentage: 4.2, investment_type: "EPSV" }
            ];
        }
        
        // Mostrar error
        function showError(message) {
            document.getElementById('assets-list').innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ff6b6b;">
                    <h3>‚ö†Ô∏è  Error</h3>
                    <p>${message}</p>
                    <p><small>Mostrando datos de ejemplo</small></p>
                </div>
            `;
        }
    </script>
</body>
</html>